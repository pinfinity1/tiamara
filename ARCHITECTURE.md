# مستندات فنی و معماری پروژه تیامارا (Tiamara)

این سند ساختار فعلی پروژه، روش‌های توسعه و استقرار، و نقشه‌ی راه فنی برای آینده را شرح می‌دهد.

---

## ۱. معماری توسعه لوکال (Local Development)

**استراتژی:** Hybrid (ترکیبی)
در این روش، دیتابیس درون کانتینر داکر اجرا می‌شود تا محیط ایزوله بماند، اما کدهای بک‌اند و فرانت‌اند مستقیماً روی سیستم‌عامل توسعه‌دهنده (Host OS) اجرا می‌شوند تا سرعت بیلد و دیباگ حداکثر باشد.

### فایل‌های پیکربندی (Configuration Files)

برای جلوگیری از تداخل پورت‌ها و متغیرها، تنظیمات به سه فایل مجزا تفکیک شده‌اند:

1.  **`/.env` (ریشه پروژه)**

    - **هدف:** تنظیمات زیرساخت داکر (فقط دیتابیس).
    - **متغیرها:** `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`.

2.  **`/server/.env` (پوشه سرور)**

    - **هدف:** تنظیمات اختصاصی بک‌اند (Express/Prisma).
    - **پورت:** `5001`
    - **اتصال دیتابیس:** `postgresql://user:password@localhost:5432/tiamara?schema=public` (اتصال به پورت باز شده داکر روی لوکال).

3.  **`/client/.env.local` (پوشه کلاینت)**
    - **هدف:** تنظیمات اختصاصی فرانت‌اند (Next.js).
    - **پورت:** `3000` (پیش‌فرض Next.js).
    - **آدرس API:** `http://localhost:5001/api` (هم برای کلاینت و هم برای سرور).

### روش اجرا (Run Instructions)

ترتیب اجرای ترمینال‌ها برای بالا آوردن پروژه:

1.  **ترمینال ۱ (ریشه):** اجرای دیتابیس
    ```bash
    docker-compose up -d
    ```
2.  **ترمینال ۲ (Server):** اجرای بک‌اند
    ```bash
    cd server
    npm run dev
    ```
3.  **ترمینال ۳ (Client):** اجرای فرانت‌اند
    ```bash
    cd client
    npm run dev
    ```

---

## ۲. معماری استقرار (Production Deployment)

**استراتژی:** Build Once, Deploy Anywhere (ساخت یک‌بار، اجرا همه‌جا)
فشار پردازشی بیلد (Build) از روی سرور برداشته شده و به گیت‌هاب منتقل شده است. سرور فقط مصرف‌کننده ایمیج‌های نهایی است.

### اجزای اصلی

1.  **GitHub Actions:** وظیفه بیلد کردن کدها، ساخت ایمیج داکر و ارسال آن به رجیستری.
2.  **GHCR (GitHub Container Registry):** محل ذخیره‌سازی امن ایمیج‌های ساخته شده.
3.  **VPS (سرور):** فقط مسئول اجرای کانتینرها با استفاده از `docker-compose`.

### فایل‌های پیکربندی سرور

1.  **`/var/www/tiamara/.env`**

    - شامل تمام متغیرهای محیطی مورد نیاز برای دیتابیس، سرور و کلاینت.
    - **نکته مهم:** `DATABASE_URL` در اینجا به سرویس `postgres` اشاره می‌کند (نه localhost).
    - **نکته مهم:** `API_BASE_URL_SERVER` به سرویس `server` اشاره می‌کند.

2.  **`docker-compose.prod.yml`**
    - مسئول مدیریت کانتینرها.
    - برای کلاینت، پورت را روی `3000` قفل می‌کند (`environment: - PORT=3000`) تا با پورت سرور تداخل نکند.

### چرخه دیپلوی (Deployment Flow)

با هر `git push origin main`، مراحل زیر خودکار انجام می‌شود:

1.  گیت‌هاب کد را دریافت می‌کند.
2.  ایمیج‌های `client` و `server` در سرورهای گیت‌هاب بیلد می‌شوند.
3.  ایمیج‌ها به `ghcr.io` ارسال می‌شوند.
4.  گیت‌هاب به سرور SSH می‌زند.
5.  سرور ایمیج‌های جدید را دانلود (Pull) می‌کند.
6.  کانتینرهای قدیمی حذف و کانتینرهای جدید جایگزین می‌شوند (`down` -> `up`).

---

## ۳. نقشه راه آینده (Future Roadmap)

اقداماتی برای ارتقای سیستم به سطح Enterprise:

### پایداری و آپ‌تایم (Stability)

- **Zero-Downtime Deployment:** پیاده‌سازی روش Blue/Green با Nginx برای حذف قطعی چند ثانیه‌ای هنگام آپدیت.
- **Backup Strategy:** اسکریپت خودکار برای `pg_dump` روزانه از دیتابیس و آپلود به فضای ابری (مانند S3).

### نظارت (Monitoring)

- **Health Checks:** افزودن اندپوینت `/health` برای بررسی زنده بودن سرویس‌ها توسط ابزارهای مانیتورینگ.
- **Centralized Logging:** راه‌اندازی ELK یا Loki برای دیدن لاگ‌ها در داشبورد به جای ترمینال سرور.

### امنیت (Security)

- **Firewall:** محدود کردن دسترسی به پورت‌های دیتابیس فقط به شبکه داخلی داکر.
- **Rate Limiting:** جلوگیری از حملات DDoS در لایه Nginx.
